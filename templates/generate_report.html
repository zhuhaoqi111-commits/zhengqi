{% extends "base.html" %}

{% block title %}生成舆情报告 - {{ super() }}{% endblock %}

{% block content %}
<div class="layui-card">
    <div class="layui-card-header">生成舆情分析报告</div>
    <div class="layui-card-body">
        <form class="layui-form" action="{{ url_for('generate_opinion_report') }}" method="post">
            <div class="layui-form-item">
                <label class="layui-form-label">报告标题</label>
                <div class="layui-input-block">
                    <input type="text" name="title" lay-verify="required" placeholder="请输入报告标题" autocomplete="off" class="layui-input">
                </div>
            </div>
            
            <div class="layui-form-item">
                <label class="layui-form-label">舆情内容</label>
                <div class="layui-input-block">
                    <textarea name="content" placeholder="请输入舆情内容，支持多段文本分析" lay-verify="required" class="layui-textarea" style="min-height: 200px;"></textarea>
                </div>
            </div>
            
            <div class="layui-form-item">
                <label class="layui-form-label">分析类型</label>
                <div class="layui-input-block">
                    <input type="radio" name="analysis_type" value="basic" title="基础分析" checked>
                    <input type="radio" name="analysis_type" value="advanced" title="深度分析">
                </div>
            </div>
            
            <div class="layui-form-item">
                <label class="layui-form-label">关键词提取</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="extract_keywords" lay-skin="switch" lay-text="开启|关闭" checked>
                </div>
            </div>
            
            <div class="layui-form-item">
                <label class="layui-form-label">情感分析</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="sentiment_analysis" lay-skin="switch" lay-text="开启|关闭" checked>
                </div>
            </div>
            
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="formDemo">立即生成报告</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="layui-card" style="margin-top: 20px;">
    <div class="layui-card-header">分析结果预览</div>
    <div class="layui-card-body">
        <div id="previewResult" style="display: none;">
            <div class="layui-tab">
                <ul class="layui-tab-title">
                    <li class="layui-this">关键词提取</li>
                    <li>情感分析</li>
                    <li>报告摘要</li>
                </ul>
                <div class="layui-tab-content">
                    <div class="layui-tab-item layui-show">
                        <div id="keywordsPreview"></div>
                    </div>
                    <div class="layui-tab-item">
                        <div id="sentimentPreview"></div>
                    </div>
                    <div class="layui-tab-item">
                        <div id="summaryPreview"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="emptyPreview" style="text-align: center; padding: 50px; color: #999;">
            <i class="layui-icon layui-icon-template" style="font-size: 48px;"></i>
            <p style="margin-top: 10px;">填写内容后点击生成报告查看分析结果</p>
        </div>
    </div>
</div>

<script>
        // 等待layui库加载完成
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof layui === 'undefined') {
                console.error('layui库未正确加载');
                return;
            }
            
            layui.use(['form', 'element'], function(){
                var form = layui.form;
                var element = layui.element;
                
                // 表单验证
                form.verify({
                    title: function(value){
                        if(value.length < 2){
                            return '报告标题至少2个字符';
                        }
                    },
                    content: function(value){
                        if(value.length < 10){
                            return '舆情内容至少10个字符';
                        }
                    }
                });
                
                // 表单提交
                form.on('submit(formDemo)', function(data){
                    // 显示加载动画
                    var index = layer.msg('正在分析舆情内容...', {icon: 16, shade: 0.3, time: 0});
                    
                    // 模拟分析过程
                    setTimeout(function(){
                        layer.close(index);
                        
                        // 显示分析结果预览
                        $('#emptyPreview').hide();
                        $('#previewResult').show();
                        
                        // 模拟分析结果
                        var content = data.field.content;
                        var keywords = ['舆情', '分析', '报告', '智能', '系统'];
                        var sentiment = content.length > 100 ? 'positive' : 'neutral';
                        
                        // 更新预览内容
                        $('#keywordsPreview').html('<div class="layui-badge-container">' + 
                            keywords.map(k => '<span class="layui-badge layui-bg-blue">' + k + '</span>').join('') + 
                            '</div>');
                            
                        $('#sentimentPreview').html('<div class="sentiment-result">' +
                            '<span class="layui-badge layui-bg-' + (sentiment === 'positive' ? 'green' : sentiment === 'negative' ? 'red' : 'gray') + '">' +
                            (sentiment === 'positive' ? '积极' : sentiment === 'negative' ? '消极' : '中性') + '</span>' +
                            '</div>');
                            
                        $('#summaryPreview').html('<p>分析完成，共提取' + keywords.length + '个关键词，情感倾向为' + 
                            (sentiment === 'positive' ? '积极' : sentiment === 'negative' ? '消极' : '中性') + '。</p>');
                        
                        // 重新渲染tab
                        element.init();
                        
                    }, 2000);
                    
                    return false; // 阻止表单跳转
                });
                
                // 实时分析功能
                $('textarea[name="content"]').on('input', function(){
                    var content = $(this).val();
                    if(content.length > 0){
                        // 可以添加实时分析功能
                    }
                });
            });
        });
    </script>

<style>
.layui-badge-container {
    margin: 10px 0;
}
.layui-badge-container .layui-badge {
    margin: 5px;
}
.sentiment-result {
    padding: 20px;
    text-align: center;
}
</style>
{% endblock %}